<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<title>换房</title>
</head>
<body>

	<include file= "./home"/>
<div id="right-show">
	
	办理续住
	<table border="1">
		<th>订单编号</th>
		<th>入住\离店日期</th>
		<th>房间类型</th>
		<th>总价</th>
		<th>订单详情</th>
		<th>入住房间</th>
		<th>操作</th>

	<form action="{:U('Home/Order/stay_over')}" method="post">
    <tr>
    	<td>{$data['o_id']}</td>
	    <td>{$data['A_date']}<br/><input id="bDay" type="date" name="bDay" value="{$data['B_date']}" onchange="calcSpread()"></td>
	    <td align="center">{$types[$data['type']]['name']}<br/>￥{$types[$data['type']]['price']}</td>
	    <td align="center">￥{$data['price']}<br/><span id="spreadPrice" style="color:red" hidden=""></span></td>
	    <td>
	    <?php
	    $book_info = json_decode($data['book_info'],true);
	    ?>
	    <p>入住晚数: {$data['nights']}</p>
	    <p>入住人数: {$book_info['number']}</p>
	    <p>入住人员信息: </p>
	    <foreach name="book_info['people_info']" item="value" >
		    <li>{$value['name']} {$value['ID_card']}</li>
	    </foreach>
	    <p>备注: {$book_info['note']}</p>
	    </td>
	    <td align="center">{$data['room_ID']}房</td>
	    <td>
	    <input type="submit" value="确定">
	    <input type="text" name="id" value="{$data['o_id']}" hidden="">
	    </td>
    </tr>
    </form>
	</table>

</div>
	<script language="JavaScript">
		function calcSpread(){/*计算差价*/

			var aDay = "<?php echo $data['A_date'];?>";
			var old_bDay = "<?php echo $data['B_date'];?>";
			var new_bDay = document.getElementById("bDay").value;
			var x = document.getElementById('spreadPrice');

			var _a = new Date(aDay.replace(/-/g, "/"));
			var _old = new Date(old_bDay.replace(/-/g, "/"));
			var _new = new Date(new_bDay.replace(/-/g, "/"));
			if (_new <= _old) {
				alert("续住日期错误！");

				document.getElementById('bDay').value = old_bDay;
				x.setAttribute("hidden","");
				x.innerHTML = "";
				return;
			};

			var all = <?php echo $data['price'];?>;// 原总价
			var price = <?php echo $types[$data['type']]['price'];?>;// 单价
			var nights = Math.floor((_new.getTime()-_a.getTime())/(24*3600*1000));// 入住总天数

			var _price = price * nights - all;// 要补的差价
			
			x.innerHTML = "+ ￥" + _price;
			x.removeAttribute("hidden");
		}
	</script>

<!-- 	1.从状态2，帮已付款但不入住的客户处理订单，状态改成“取消订单”0
	2.从状态1或2，办理客户入住，核对入住人信息，分配房间，确认，状态改成“正在入住”3
	3.从状态3，办理客户退房（只有“正在入住”状态能看到“退房”选项），确认，状态改成“已退房”4
	4.从状态3，帮已入住客户办理换房手续（只有“正在入住”状态能看到“换房”选项），换房，分配房间，确认，换房记录写入数据库


	公共订房流程：
	   下单，状态1->取消，状态0     --客户自行解决
	现金支付订房流程：
	   下单，状态1->给现金，正在入住，状态3->退房，状态4
	网上支付订房流程：（指下单后在网上自行支付了，到店只需办理入住的）
	   下单，状态1->支付，状态2->取消，状态0
       下单，状态1->支付，状态2->正在入住，状态3->退房，状态4 -->
	
</body>
</html>